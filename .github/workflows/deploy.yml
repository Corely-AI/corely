name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # TODO: Add this secret to your repo
  REGION: europe-west4 # Netherlands (better domain mapping support)
  GAR_LOCATION: europe-west4 # Netherlands
  REPOSITORY: corely-images # TODO: Create this Artifact Registry repository

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_CREDENTIALS }}

      - name: Build and Push API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.api
          push: true
          tags: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # - name: Build and Push Worker
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: .
      #     file: Dockerfile.worker
      #     push: true
      #     tags: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      - name: Deploy API to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: corely-api
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}
          flags: --port=8080 --allow-unauthenticated
          env_vars: |
            NODE_ENV=production
            WORKFLOW_QUEUE_DRIVER=memory

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # - name: Run DB migrations (Cloud Run job)
      #   shell: bash
      #   run: |
      #     set -euo pipefail

      #     JOB_NAME="corely-api-migrate"
      #     IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}"

      #     if gcloud run jobs describe "$JOB_NAME" --region "${{ env.REGION }}" >/dev/null 2>&1; then
      #       gcloud run jobs update "$JOB_NAME" \
      #         --region "${{ env.REGION }}" \
      #         --image "$IMAGE" \
      #         --command "sh" \
      #         --args "-c,cd /app && pnpm --filter @corely/data exec prisma migrate deploy" \
      #         --set-env-vars "NODE_ENV=production" \
      #         --set-secrets "DATABASE_URL=projects/${{ env.PROJECT_ID }}/secrets/DATABASE_URL:latest"
      #     else
      #       gcloud run jobs create "$JOB_NAME" \
      #         --region "${{ env.REGION }}" \
      #         --image "$IMAGE" \
      #         --command "sh" \
      #         --args "-c,cd /app && pnpm --filter @corely/data exec prisma migrate deploy" \
      #         --set-env-vars "NODE_ENV=production" \
      #         --set-secrets "DATABASE_URL=projects/${{ env.PROJECT_ID }}/secrets/DATABASE_URL:latest"
      #     fi

      #     gcloud run jobs execute "$JOB_NAME" --region "${{ env.REGION }}" --wait

      # - name: Deploy Worker to Cloud Run
      #   uses: google-github-actions/deploy-cloudrun@v2
      #   with:
      #     service: corely-worker
      #     region: ${{ env.REGION }}
      #     image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }}
      #     flags: --port=3000
      #     env_vars: |
      #       NODE_ENV=production
      #       WORKFLOW_QUEUE_DRIVER=cloudtasks
      #     # secrets: |
      #     #   DATABASE_URL=projects/${{ env.PROJECT_ID }}/secrets/DATABASE_URL:latest
