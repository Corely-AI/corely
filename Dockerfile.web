# Simple single-stage image for the Web frontend.
FROM node:22-alpine

RUN corepack enable pnpm

WORKDIR /app

# Workspace manifests (keeps install cache-friendly)
COPY .npmrc pnpm-workspace.yaml pnpm-lock.yaml package.json ./
COPY apps/web/package.json ./apps/web/
COPY packages/contracts/package.json ./packages/contracts/
COPY packages/api-client/package.json ./packages/api-client/
COPY packages/offline-core/package.json ./packages/offline-core/
COPY packages/offline-web/package.json ./packages/offline-web/

# Install all workspace deps
# Using shamefully-hoist for compatibility
RUN pnpm install --frozen-lockfile --recursive

# Copy source
COPY tsconfig.base.json tsconfig.web.json ./
COPY packages ./packages
COPY apps/web ./apps/web

# Build packages that web depends on
RUN pnpm --filter @kerniflow/contracts build \
 && pnpm --filter @kerniflow/offline-core build \
 && pnpm --filter @kerniflow/offline-web build \
 && pnpm --filter @kerniflow/api-client build

# Expose Vite dev server port
EXPOSE 8080

# Default environment
ENV NODE_ENV=development
ENV VITE_API_BASE_URL=http://localhost:3000

# Run Vite dev server bound to 0.0.0.0 (accessible from host)
WORKDIR /app/apps/web
CMD ["../../node_modules/.bin/vite", "--host", "0.0.0.0"]
