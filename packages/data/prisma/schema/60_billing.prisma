model Invoice {
  id          String        @id @default(cuid())
  tenantId    String
  customerPartyId    String
  billToName         String?
  billToEmail        String?
  billToVatId        String?
  billToAddressLine1 String?
  billToAddressLine2 String?
  billToCity         String?
  billToPostalCode   String?
  billToCountry      String?
  number      String?
  status      InvoiceStatus @default(DRAFT)
  currency    String          @db.VarChar(3)
  notes       String?
  terms       String?
  
  // References
  legalEntityId   String?
  paymentMethodId String?

  // Snapshots (Immutable copies at time of issuance)
  issuerSnapshot  Json?      @db.JsonB
  taxSnapshot     Json?      @db.JsonB
  paymentSnapshot Json?      @db.JsonB
  
  // Legacy/Other
  paymentDetails Json?
  invoiceDate DateTime?     @db.Date
  dueDate     DateTime?     @db.Date
  issuedAt    DateTime?     @db.Timestamptz(6)
  sentAt      DateTime?     @db.Timestamptz(6)
  createdAt   DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(6)

  pdfStorageKey     String?
  pdfGeneratedAt    DateTime? @db.Timestamptz(6)
  pdfSourceVersion  String?
  pdfStatus         PdfStatus @default(NONE)
  pdfFailureReason  String?
  sourceType        String?
  sourceId          String?

  lines     InvoiceLine[]
  payments  InvoicePayment[]
  
  legalEntity     LegalEntity?   @relation(fields: [legalEntityId], references: [id])
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, customerPartyId])
  @@index([tenantId, createdAt])
  @@index([legalEntityId])
  @@index([paymentMethodId])
  @@unique([tenantId, number])
  @@schema("billing")
}

model InvoiceLine {
  id             String   @id @default(cuid())
  invoiceId      String
  description    String
  qty            Int
  unitPriceCents Int

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@schema("billing")
}

model InvoicePayment {
  id          String   @id @default(cuid())
  invoiceId   String
  amountCents Int
  paidAt      DateTime @db.Timestamptz(6)
  note        String?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@schema("billing")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  CANCELED
  @@schema("billing")
}

model InvoiceEmailDelivery {
  id                 String         @id @default(cuid())
  tenantId           String
  invoiceId          String
  to                 String
  status             DeliveryStatus @default(QUEUED)
  provider           String         @default("resend")
  providerMessageId  String?
  idempotencyKey     String
  lastError          String?
  createdAt          DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime       @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId, invoiceId])
  @@index([providerMessageId])
  @@schema("billing")
}

enum DeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
  DELAYED
  @@schema("billing")
}

enum PdfStatus {
  NONE
  GENERATING
  READY
  FAILED
  @@schema("billing")
}
