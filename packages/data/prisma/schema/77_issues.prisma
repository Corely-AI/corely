enum IssueStatus {
  NEW
  TRIAGED
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
  REOPENED

  @@schema("crm")
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("crm")
}

enum IssueSiteType {
  FIELD
  CUSTOMER
  MANUFACTURER

  @@schema("crm")
}

enum IssueAttachmentKind {
  IMAGE
  AUDIO

  @@schema("crm")
}

enum IssueActivityType {
  CREATED
  COMMENT_ADDED
  STATUS_CHANGED
  ATTACHMENT_ADDED
  RESOLVED
  REOPENED
  ASSIGNED

  @@schema("crm")
}

enum IssueTranscriptionStatus {
  PENDING
  COMPLETED
  FAILED

  @@schema("crm")
}

model Issue {
  id                  String        @id @default(cuid())
  tenantId            String
  title               String
  description         String?
  status              IssueStatus   @default(NEW)
  priority            IssuePriority @default(MEDIUM)
  siteType            IssueSiteType
  siteId              String?
  customerPartyId     String?
  manufacturerPartyId String?
  assigneeUserId      String?
  reporterUserId      String?
  resolvedAt          DateTime?     @db.Timestamptz(6)
  resolvedByUserId    String?
  closedAt            DateTime?     @db.Timestamptz(6)
  createdAt           DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime      @updatedAt @db.Timestamptz(6)

  comments    IssueComment[]
  attachments IssueAttachment[]
  activity    IssueActivity[]

  @@index([tenantId, status])
  @@index([tenantId, assigneeUserId])
  @@index([tenantId, siteType])
  @@index([tenantId, createdAt])
  @@schema("crm")
}

model IssueComment {
  id              String   @id @default(cuid())
  tenantId        String
  issueId         String
  body            String
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  createdByUserId String

  issue       Issue             @relation(fields: [issueId], references: [id], onDelete: Cascade)
  attachments IssueAttachment[]

  @@index([tenantId, issueId, createdAt])
  @@schema("crm")
}

model IssueAttachment {
  id                     String                    @id @default(cuid())
  tenantId               String
  issueId                String
  commentId              String?
  documentId             String
  kind                   IssueAttachmentKind
  mimeType               String
  sizeBytes              Int
  durationSeconds        Int?
  transcriptText         String?
  transcriptSegmentsJson String?
  transcriptionStatus    IssueTranscriptionStatus?
  transcriptionError     String?
  createdAt              DateTime                  @default(now()) @db.Timestamptz(6)
  createdByUserId        String?

  issue   Issue         @relation(fields: [issueId], references: [id], onDelete: Cascade)
  comment IssueComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([tenantId, issueId])
  @@index([tenantId, commentId])
  @@index([tenantId, documentId])
  @@schema("crm")
}

model IssueActivity {
  id              String            @id @default(cuid())
  tenantId        String
  issueId         String
  type            IssueActivityType
  metadataJson    String?
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  createdByUserId String?

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([tenantId, issueId, createdAt])
  @@schema("crm")
}
