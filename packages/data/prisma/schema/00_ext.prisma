// ===========================
// Extension Storage Schema
// ===========================
//
// This schema provides universal storage primitives for small modules
// that don't need dedicated tables. Supports 1000+ modules without
// exploding the PostgreSQL catalog size.
//
// See: docs/architecture/DATABASE_PERSISTENCE_STRATEGY.md

// Key-Value Storage
// Use for: module settings, small datasets, cached values
model ExtKv {
  id        String   @id @default(cuid())
  tenantId  String
  moduleId  String // Namespace for module isolation
  scope     String // e.g., "workspace", "user", "entity"
  key       String
  value     Json // JSONB payload
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, moduleId, scope, key])
  @@index([tenantId, moduleId])
  @@schema("ext")
}

// Entity Attributes
// Use for: custom fields, module-specific metadata on core entities
model ExtEntityAttr {
  id         String   @id @default(cuid())
  tenantId   String
  moduleId   String // Namespace for module isolation
  entityType String // e.g., "Party", "Invoice", "Deal"
  entityId   String // ID of the target entity
  attrKey    String // Attribute name
  attrValue  Json // JSONB payload
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, moduleId, entityType, entityId, attrKey])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, moduleId])
  @@schema("ext")
}

// Entity Links
// Use for: cross-entity relationships, graph-like associations
model ExtEntityLink {
  id             String   @id @default(cuid())
  tenantId       String
  moduleId       String // Namespace for module isolation
  fromEntityType String // Source entity type
  fromEntityId   String // Source entity ID
  toEntityType   String // Target entity type
  toEntityId     String // Target entity ID
  linkType       String // Relationship type (e.g., "related", "depends_on")
  metadata       Json? // Optional metadata
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  @@unique([tenantId, moduleId, fromEntityType, fromEntityId, toEntityType, toEntityId, linkType])
  @@index([tenantId, fromEntityType, fromEntityId])
  @@index([tenantId, toEntityType, toEntityId])
  @@index([tenantId, moduleId, linkType])
  @@schema("ext")
}
