// ============================================================================
// Tax Module Models
// ============================================================================

// Tax Profile
// Defines tenant's tax configuration for a jurisdiction
model TaxProfile {
  id                    String              @id @default(cuid())
  tenantId              String
  country               String // ISO 2-letter code (e.g., "DE")
  regime                TaxRegime
  vatEnabled            Boolean             @default(true)
  vatId                 String?
  currency              String              @default("EUR") @db.VarChar(3)
  filingFrequency       VatFilingFrequency
  taxYearStartMonth     Int?
  vatAccountingMethod   VatAccountingMethod @default(IST)
  localTaxOfficeName    String?
  vatExemptionParagraph String?

  // Flags
  euB2BSales     Boolean @default(false)
  hasEmployees   Boolean @default(false)
  usesTaxAdvisor Boolean @default(false)

  effectiveFrom DateTime  @db.Timestamptz(6)
  effectiveTo   DateTime? @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, effectiveFrom])
  @@index([tenantId, country])
  @@schema("billing")
}

enum VatAccountingMethod {
  IST // Cash accounting (received date)
  SOLL // Accrual accounting (invoice date)

  @@schema("billing")
}

enum TaxRegime {
  SMALL_BUSINESS // Kleinunternehmer (ยง19 UStG) - no VAT charged
  STANDARD_VAT // Regular VAT
  VAT_EXEMPT // Exempt from VAT according to ยง4 Tax Act

  @@schema("billing")
}

enum VatFilingFrequency {
  MONTHLY
  QUARTERLY
  YEARLY

  @@schema("billing")
}

// Tax Code
// Defines tax classifications (e.g., "STANDARD_VAT_19", "REDUCED_VAT_7")
model TaxCode {
  id        String      @id @default(cuid())
  tenantId  String
  code      String // e.g., "STANDARD_19", "REDUCED_7"
  kind      TaxCodeKind
  label     String // human-readable label
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt DateTime    @updatedAt @db.Timestamptz(6)

  rates TaxRate[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@schema("billing")
}

enum TaxCodeKind {
  STANDARD // Standard VAT rate (19% in DE)
  REDUCED // Reduced VAT rate (7% in DE)
  REVERSE_CHARGE // B2B cross-border (no VAT charged, customer self-assesses)
  EXEMPT // Exempt from VAT
  ZERO // 0% VAT rate

  @@schema("billing")
}

// Tax Rate
// Effective-dated rate for a tax code
model TaxRate {
  id            String    @id @default(cuid())
  tenantId      String
  taxCodeId     String
  rateBps       Int // basis points (e.g., 1900 = 19.00%)
  effectiveFrom DateTime  @db.Timestamptz(6)
  effectiveTo   DateTime? @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  taxCode TaxCode @relation(fields: [taxCodeId], references: [id], onDelete: Cascade)

  @@index([tenantId, taxCodeId])
  @@index([effectiveFrom])
  @@schema("billing")
}

// Tax Snapshot
// Immutable tax calculation for finalized documents (invoices, expenses)
model TaxSnapshot {
  id           String          @id @default(cuid())
  tenantId     String
  sourceType   TaxSourceType // INVOICE or EXPENSE
  sourceId     String // invoice.id or expense.id
  jurisdiction String // e.g., "DE"
  regime       TaxRegime
  roundingMode TaxRoundingMode
  currency     String          @db.VarChar(3)
  calculatedAt DateTime        @db.Timestamptz(6)

  // Totals (denormalized for performance)
  subtotalAmountCents Int
  taxTotalAmountCents Int
  totalAmountCents    Int

  // Full breakdown stored as JSON
  breakdownJson String @db.Text // stringified TaxBreakdownDto

  version   Int      @default(1)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, sourceType, sourceId]) // Idempotency key
  @@index([tenantId, sourceType])
  @@index([calculatedAt])
  @@schema("billing")
}

enum TaxSourceType {
  INVOICE
  EXPENSE

  @@schema("billing")
}

enum TaxRoundingMode {
  PER_LINE // Round tax on each line item
  PER_DOCUMENT // Round total tax at document level

  @@schema("billing")
}

// VAT Period Summary
// Aggregated tax data for reporting periods
model VatPeriodSummary {
  id          String   @id @default(cuid())
  tenantId    String
  periodStart DateTime @db.Timestamptz(6)
  periodEnd   DateTime @db.Timestamptz(6)
  currency    String   @db.VarChar(3)

  // Totals by kind (stored as JSON)
  totalsByKindJson String @db.Text // stringified TaxTotalsByKind

  generatedAt DateTime        @db.Timestamptz(6)
  status      VatPeriodStatus @default(OPEN)
  createdAt   DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime        @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, periodStart, periodEnd])
  @@index([tenantId, status])
  @@index([periodStart])
  @@schema("billing")
}

enum VatPeriodStatus {
  OPEN
  OVERDUE
  SUBMITTED
  PAID
  NIL
  ARCHIVED

  @@schema("billing")
}

// Tax Consultant
model TaxConsultant {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@schema("billing")
}

// Tax Reports (scheduled obligations)
model TaxReport {
  id                   String          @id @default(cuid())
  tenantId             String
  type                 TaxReportType
  group                TaxReportGroup
  periodLabel          String
  periodStart          DateTime        @db.Timestamptz(6)
  periodEnd            DateTime        @db.Timestamptz(6)
  dueDate              DateTime        @db.Timestamptz(6)
  status               TaxReportStatus
  amountEstimatedCents Int?
  amountFinalCents     Int?
  currency             String          @default("EUR") @db.VarChar(3)
  submittedAt          DateTime?       @db.Timestamptz(6)
  submissionReference  String?
  submissionNotes      String?
  archivedReason       String?
  pdfStorageKey        String?
  pdfGeneratedAt       DateTime?       @db.Timestamptz(6)
  meta                 Json?
  createdAt            DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime        @updatedAt @db.Timestamptz(6)

  lines TaxReportLine[]

  @@unique([tenantId, type, periodStart, periodEnd])
  @@index([tenantId, status])
  @@index([tenantId, periodStart, periodEnd])
  @@schema("billing")
}

enum TaxReportStatus {
  UPCOMING
  OPEN
  SUBMITTED
  OVERDUE
  PAID
  NIL
  ARCHIVED

  @@schema("billing")
}

enum TaxReportType {
  VAT_ADVANCE
  VAT_ANNUAL
  INCOME_TAX
  EU_SALES_LIST
  INTRASTAT
  PAYROLL_TAX
  PROFIT_LOSS
  BALANCE_SHEET
  TRADE_TAX
  FIXED_ASSETS
  EXCISE_MONTHLY

  @@schema("billing")
}

enum TaxReportGroup {
  ADVANCE_VAT
  ANNUAL_REPORT
  COMPLIANCE
  PAYROLL
  FINANCIAL_STATEMENT
  EXCISE

  @@schema("billing")
}

// Tax Report Lines (for ESL, Intrastat, etc.)
model TaxReportLine {
  id       String    @id @default(cuid())
  tenantId String
  reportId String
  report   TaxReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Generic line data
  section String? // e.g., "Goods", "Services"
  label   String? // e.g., Customer Name

  // Amounts
  netAmountCents Int
  taxAmountCents Int?

  // Metadata (ESL: vatId, country; Intrastat: commodityCode, weight)
  meta Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([reportId])
  @@schema("billing")
}
