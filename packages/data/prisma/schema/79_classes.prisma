enum ClassGroupStatus {
  ACTIVE
  ARCHIVED
  @@schema("crm")
}

enum ClassGroupKind {
  COHORT
  DROP_IN
  OFFICE_HOURS
  WORKSHOP
  @@schema("crm")
}

enum ClassGroupLifecycle {
  DRAFT
  PUBLISHED
  RUNNING
  ENDED
  ARCHIVED
  @@schema("crm")
}

enum ClassDeliveryMode {
  ONLINE
  HYBRID
  IN_PERSON
  @@schema("crm")
}

enum ClassGroupInstructorRole {
  INSTRUCTOR
  MENTOR
  TA
  @@schema("crm")
}

enum ClassSessionStatus {
  PLANNED
  DONE
  CANCELLED
  @@schema("crm")
}

enum ClassSessionType {
  LECTURE
  LAB
  OFFICE_HOURS
  REVIEW
  DEMO_DAY
  @@schema("crm")
}

enum MeetingProvider {
  ZOOM
  GOOGLE_MEET
  TEAMS
  OTHER
  @@schema("crm")
}

enum ClassEnrollmentStatus {
  APPLIED
  ENROLLED
  DEFERRED
  DROPPED
  COMPLETED
  @@schema("crm")
}

enum ClassEnrollmentSeatType {
  LEARNER
  AUDITOR
  SPONSORED
  @@schema("crm")
}

enum ClassEnrollmentSource {
  SELF_SERVE
  SALES
  ADMIN
  PARTNER
  @@schema("crm")
}

enum ClassAttendanceStatus {
  PRESENT
  ABSENT
  MAKEUP
  EXCUSED
  @@schema("crm")
}

enum ClassBillingRunStatus {
  DRAFT
  INVOICES_CREATED
  LOCKED
  FAILED
  @@schema("crm")
}

enum ClassBillingMonthStrategy {
  PREPAID_CURRENT_MONTH
  ARREARS_PREVIOUS_MONTH
  @@schema("crm")
}

enum ClassBillingBasis {
  SCHEDULED_SESSIONS
  ATTENDED_SESSIONS
  @@schema("crm")
}

enum ClassEnrollmentBillingPlanType {
  UPFRONT
  INSTALLMENTS
  INVOICE_NET
  SUBSCRIPTION
  @@schema("crm")
}

enum ClassBillingInvoicePurpose {
  DEPOSIT
  INSTALLMENT
  FINAL
  ADHOC
  MONTHLY_RUN
  @@schema("crm")
}

enum ClassMilestoneType {
  PROJECT
  ASSESSMENT
  CHECKPOINT
  @@schema("crm")
}

enum ClassMilestoneCompletionStatus {
  NOT_STARTED
  SUBMITTED
  PASSED
  FAILED
  @@schema("crm")
}

enum ClassResourceType {
  RECORDING
  DOC
  LINK
  @@schema("crm")
}

enum ClassResourceVisibility {
  ENROLLED_ONLY
  PUBLIC
  @@schema("crm")
}

model ClassProgram {
  id                    String   @id @default(cuid())
  tenantId              String
  workspaceId           String
  title                 String
  description           String?
  levelTag              String?
  expectedSessionsCount Int?
  defaultTimezone       String?
  createdAt             DateTime @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @db.Timestamptz(6)

  classGroups           ClassGroup[]
  sessionTemplates      ClassProgramSessionTemplate[]
  milestoneTemplates    ClassProgramMilestoneTemplate[]

  @@index([tenantId, workspaceId])
  @@index([tenantId, levelTag])
  @@schema("crm")
}

model ClassProgramSessionTemplate {
  id                 String           @id @default(cuid())
  tenantId           String
  workspaceId        String
  programId          String
  index              Int
  title              String?
  defaultDurationMin Int?
  type               ClassSessionType @default(LECTURE)
  createdAt          DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @db.Timestamptz(6)

  program            ClassProgram     @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([tenantId, programId, index], name: "tenantId_programId_index")
  @@index([tenantId, programId])
  @@schema("crm")
}

model ClassProgramMilestoneTemplate {
  id         String             @id @default(cuid())
  tenantId   String
  workspaceId String
  programId  String
  title      String
  type       ClassMilestoneType @default(CHECKPOINT)
  required   Boolean            @default(true)
  index      Int
  createdAt  DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime           @updatedAt @db.Timestamptz(6)

  program    ClassProgram       @relation(fields: [programId], references: [id], onDelete: Cascade)
  milestones ClassMilestone[]

  @@unique([tenantId, programId, index], name: "tenantId_programId_milestone_index")
  @@index([tenantId, programId])
  @@schema("crm")
}

model ClassGroup {
  id                     String              @id @default(cuid())
  tenantId               String
  workspaceId            String
  name                   String
  subject                String
  level                  String
  defaultPricePerSession Int
  currency               String              @default("EUR") @db.VarChar(3)
  schedulePattern        Json?               @db.JsonB
  status                 ClassGroupStatus    @default(ACTIVE)
  kind                   ClassGroupKind      @default(COHORT)
  lifecycle              ClassGroupLifecycle @default(DRAFT)
  startAt                DateTime?           @db.Timestamptz(6)
  endAt                  DateTime?           @db.Timestamptz(6)
  timezone               String              @default("UTC")
  capacity               Int?
  waitlistEnabled        Boolean             @default(false)
  deliveryMode           ClassDeliveryMode   @default(ONLINE)
  communityUrl           String?
  programId              String?
  createdAt              DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime            @updatedAt @db.Timestamptz(6)

  program                ClassProgram?       @relation(fields: [programId], references: [id], onDelete: SetNull)
  sessions               ClassSession[]
  enrollments            ClassEnrollment[]
  instructors            ClassGroupInstructor[]
  milestones             ClassMilestone[]
  resources              ClassGroupResource[]

  @@index([tenantId, workspaceId])
  @@index([tenantId, status])
  @@index([tenantId, kind])
  @@index([tenantId, lifecycle])
  @@index([tenantId, startAt])
  @@index([tenantId, programId])
  @@schema("crm")
}

model ClassGroupInstructor {
  id           String                   @id @default(cuid())
  tenantId     String
  workspaceId  String
  classGroupId String
  partyId      String
  role         ClassGroupInstructorRole @default(INSTRUCTOR)
  createdAt    DateTime                 @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime                 @updatedAt @db.Timestamptz(6)

  classGroup   ClassGroup               @relation(fields: [classGroupId], references: [id], onDelete: Cascade)

  @@unique([tenantId, classGroupId, partyId, role], name: "tenantId_classGroupId_partyId_role")
  @@index([tenantId, partyId])
  @@index([tenantId, classGroupId])
  @@schema("crm")
}

model ClassSession {
  id                String             @id @default(cuid())
  tenantId          String
  workspaceId       String
  classGroupId      String
  startsAt          DateTime           @db.Timestamptz(6)
  endsAt            DateTime?          @db.Timestamptz(6)
  topic             String?
  notes             String?
  status            ClassSessionStatus @default(PLANNED)
  type              ClassSessionType   @default(LECTURE)
  meetingProvider   MeetingProvider?
  meetingJoinUrl    String?
  meetingExternalId String?
  createdAt         DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime           @updatedAt @db.Timestamptz(6)

  classGroup        ClassGroup         @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  attendance        ClassAttendance[]

  @@unique([tenantId, classGroupId, startsAt], name: "tenantId_classGroupId_startsAt")
  @@index([tenantId, workspaceId, startsAt])
  @@index([tenantId, classGroupId])
  @@schema("crm")
}

model ClassEnrollment {
  id                      String                  @id @default(cuid())
  tenantId                String
  workspaceId             String
  classGroupId            String
  studentClientId         String
  payerClientId           String
  payerPartyId            String?
  status                  ClassEnrollmentStatus   @default(ENROLLED)
  seatType                ClassEnrollmentSeatType @default(LEARNER)
  source                  ClassEnrollmentSource   @default(ADMIN)
  startDate               DateTime?               @db.Date
  endDate                 DateTime?               @db.Date
  isActive                Boolean                 @default(true)
  priceOverridePerSession Int?
  priceCents              Int?
  currency                String?                 @db.VarChar(3)
  discountCents           Int?
  discountLabel           String?
  placementLevel          String?
  placementGoal           String?
  placementNote           String?
  createdAt               DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime                @updatedAt @db.Timestamptz(6)

  classGroup              ClassGroup                @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  attendance              ClassAttendance[]
  billingPlan             ClassEnrollmentBillingPlan?
  milestoneCompletions    ClassMilestoneCompletion[]
  billingInvoiceLinks     ClassBillingInvoiceLink[]

  @@unique([tenantId, classGroupId, studentClientId], name: "tenantId_classGroupId_studentClientId")
  @@index([tenantId, classGroupId])
  @@index([tenantId, payerClientId])
  @@index([tenantId, payerPartyId])
  @@index([tenantId, isActive])
  @@index([tenantId, status])
  @@schema("crm")
}

model ClassEnrollmentBillingPlan {
  id           String                        @id @default(cuid())
  tenantId     String
  workspaceId  String
  enrollmentId String                        @unique
  type         ClassEnrollmentBillingPlanType
  scheduleJson Json                          @db.JsonB
  createdAt    DateTime                      @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime                      @updatedAt @db.Timestamptz(6)

  enrollment   ClassEnrollment               @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([tenantId, workspaceId])
  @@index([tenantId, type])
  @@schema("crm")
}

model ClassAttendance {
  id           String                @id @default(cuid())
  tenantId     String
  workspaceId  String
  sessionId    String
  enrollmentId String
  status       ClassAttendanceStatus
  billable     Boolean               @default(true)
  note         String?
  createdAt    DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime              @updatedAt @db.Timestamptz(6)

  session      ClassSession          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollment   ClassEnrollment       @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sessionId, enrollmentId], name: "tenantId_sessionId_enrollmentId")
  @@index([tenantId, sessionId])
  @@index([tenantId, enrollmentId])
  @@schema("crm")
}

model ClassMonthlyBillingRun {
  id                   String                     @id @default(cuid())
  tenantId             String
  workspaceId          String
  month                String                     @db.VarChar(7)
  billingMonthStrategy ClassBillingMonthStrategy  @default(ARREARS_PREVIOUS_MONTH)
  billingBasis         ClassBillingBasis          @default(ATTENDED_SESSIONS)
  billingSnapshot      Json?                      @db.JsonB
  status               ClassBillingRunStatus      @default(DRAFT)
  runId                String
  generatedAt          DateTime?                  @db.Timestamptz(6)
  createdByUserId      String
  createdAt            DateTime                   @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime                   @updatedAt @db.Timestamptz(6)

  invoices             ClassBillingInvoiceLink[]

  @@unique([tenantId, month], name: "tenantId_month")
  @@index([tenantId, status])
  @@schema("crm")
}

model ClassBillingInvoiceLink {
  id             String                     @id @default(cuid())
  tenantId       String
  workspaceId    String
  billingRunId   String?
  enrollmentId   String?
  payerClientId  String
  classGroupId   String?
  invoiceId      String
  idempotencyKey String
  purpose        ClassBillingInvoicePurpose @default(MONTHLY_RUN)
  createdAt      DateTime                   @default(now()) @db.Timestamptz(6)

  billingRun     ClassMonthlyBillingRun?    @relation(fields: [billingRunId], references: [id], onDelete: Cascade)
  enrollment     ClassEnrollment?           @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)

  @@unique([tenantId, billingRunId, payerClientId, classGroupId], name: "tenantId_billingRunId_payerClientId_classGroupId")
  @@unique([tenantId, idempotencyKey], name: "tenantId_idempotencyKey")
  @@index([tenantId, billingRunId])
  @@index([tenantId, enrollmentId])
  @@index([tenantId, payerClientId])
  @@index([tenantId, classGroupId])
  @@schema("crm")
}

model ClassMilestone {
  id                         String             @id @default(cuid())
  tenantId                   String
  workspaceId                String
  classGroupId               String
  programMilestoneTemplateId String?
  title                      String
  type                       ClassMilestoneType @default(CHECKPOINT)
  dueAt                      DateTime?          @db.Timestamptz(6)
  required                   Boolean            @default(true)
  index                      Int?
  createdAt                  DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt                  DateTime           @updatedAt @db.Timestamptz(6)

  classGroup                 ClassGroup                   @relation(fields: [classGroupId], references: [id], onDelete: Cascade)
  programMilestoneTemplate   ClassProgramMilestoneTemplate? @relation(fields: [programMilestoneTemplateId], references: [id], onDelete: SetNull)
  completions                ClassMilestoneCompletion[]

  @@index([tenantId, classGroupId])
  @@index([tenantId, dueAt])
  @@schema("crm")
}

model ClassMilestoneCompletion {
  id              String                         @id @default(cuid())
  tenantId        String
  workspaceId     String
  milestoneId     String
  enrollmentId    String
  status          ClassMilestoneCompletionStatus @default(NOT_STARTED)
  score           Int?
  feedback        String?
  gradedByPartyId String?
  gradedAt        DateTime?                      @db.Timestamptz(6)
  createdAt       DateTime                       @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime                       @updatedAt @db.Timestamptz(6)

  milestone       ClassMilestone                 @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  enrollment      ClassEnrollment                @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, milestoneId, enrollmentId], name: "tenantId_milestoneId_enrollmentId")
  @@index([tenantId, enrollmentId])
  @@schema("crm")
}

model ClassGroupResource {
  id          String                  @id @default(cuid())
  tenantId    String
  workspaceId String
  classGroupId String
  type        ClassResourceType
  title       String
  documentId  String?
  url         String?
  visibility  ClassResourceVisibility @default(ENROLLED_ONLY)
  sortOrder   Int                     @default(0)
  createdAt   DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime                @updatedAt @db.Timestamptz(6)

  classGroup  ClassGroup              @relation(fields: [classGroupId], references: [id], onDelete: Cascade)

  @@index([tenantId, classGroupId, sortOrder])
  @@index([tenantId, documentId])
  @@schema("crm")
}
